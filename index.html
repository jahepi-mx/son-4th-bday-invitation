<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdn.tailwindcss.com"></script>
        <style type="text/css">
            #canvas { 
                height: 100vh; 
                width: 100vw;
                display: block;
                position: fixed; 
                top: 0;
                left: 0;
                z-index: -1;
            }
        </style>
        <script src="assets.js"></script>
        <script src="atlas.js"></script>
        <script src="animation.js"></script>
        <script src="vector.js"></script>
        <script src="camera.js"></script>
        <script src="chase.js"></script>
        <script src="ball.js"></script>
        <script src="background.js"></script>
        <script>
        var canvas = null;
        var context = null;
        var camera = new Camera();
        var backgrounds = [];
        var prevTime = 0;
        var bots = [];
        var bot = null;
        var focusTime = 0;

        window.onload = function() {
            canvas = document.getElementById("canvas");
            canvas.width = camera.viewPortWidth;
            canvas.height = camera.viewPortHeight;
            context = canvas.getContext("2d");
            bots = [new Chase(camera), new Chase(camera)];
            var assets = Assets.getInstance();
            assets.loadAll(onLoadAssets, onDownloadAssets);
        }

        function onDownloadAssets() {
        }
            
        function onLoadAssets() {
            var atlas = Atlas.getInstance();
            atlas.loadAll(onLoadAtlas, onDownloadAtlas);
        }

        function onDownloadAtlas() {
        }
            
        function onLoadAtlas() {
            backgrounds = [
                new Background(camera, "clouds", 0.4, camera.viewPortHeight - 300 * 0.5, 300), 
                new Background(camera, "mountains", 0.6, 200, 150), 
                new Background(camera, "trees", 0.8, 120, 150),
                new Background(camera, "floors", 1, 65 * 0.5, 65)
            ];
            requestAnimationFrame(update);
        }

        function update(time) {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.imageSmoothingEnabled = false;
            var dt = (time - prevTime) / 1000;
            var fps = 1 / dt;
            focusTime -= dt;
            prevTime = time;

            if (fps < 3) {
                requestAnimationFrame(update);
                return;
            }

            if (focusTime <= 0) {
                focusTime = Math.random() * 10 + 10;
                bot = bots[parseInt(bots.length * Math.random())];
            }

            camera.position.x += (bot.position.x - camera.position.x) * dt;
            camera.position.y += (bot.position.y - camera.position.y) * dt;

            camera.update();

            for (let background of backgrounds) {
                background.update(dt);
                background.render(context);
            }

            for (let tmpBot of bots) {
                tmpBot.update(dt);
                tmpBot.render(context);
            }

            requestAnimationFrame(update);
        }

        function sendData() {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", 'https://jahepi.net/birthday/email.php', true);
            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr.onload = function(e) {
                var res = xhr.responseText;
                if (res == "ok") {
                    document.getElementById("status").className = "text-green-500 text-sm font-bold";
                    document.getElementById("status").innerHTML = "Gracias por confirma la asistencia!!!";
                    document.getElementById("name").value = "";
                } else {
                    document.getElementById("status").className = "text-red-500 text-sm font-bold";
                    document.getElementById("status").innerHTML = "Hubo un error, escribe tu nombre.";
                }
            }
            xhr.send("name=" + document.getElementById("name").value);
        }
        </script>
    </head>
    <body style="margin:0; padding: 0">
        <div class="flex justify-center">
            <div class="w-full max-w-sm  my-5">
                <form class="bg-white shadow-md rounded px-4 pt-4 pb-4 mb-4 bg-opacity-80">
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm mb-2" for="name">
                    Te esperamos este sábado 16 de Diciembre a partir de las 3 PM para celebrar los 4 años de Iktan.
                    </label>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="name">
                        Confirma tu asistencia!
                    </label>
                    <input class="shadow appearance-none border border-green-500 rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="name" name="name" type="text" placeholder="Nombre">
                    <p id="status" class="text-green-500 text-xs italic">Escribe tu nombre.</p>
                </div>
                <div class="flex items-center justify-between">
                    <button onclick="sendData()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                    Confirmar
                    </button>
                    <a class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800" href="#">
                    Ubicación Evento
                    </a>
                </div>
                </form>
            </div>
        </div>
        <canvas id="canvas" name="canvas" />
    </body>
</html>